<!DOCTYPE html>
<html>

<head>
    <title>TicTacToe API Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
        }

        input,
        select {
            width: 200px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .button-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .btn-create {
            background-color: #28a745;
            color: white;
        }

        .btn-state {
            background-color: #007bff;
            color: white;
        }

        .btn-move {
            background-color: #ffc107;
            color: black;
        }

        .btn-choose {
            background-color: #6f42c1;
            color: white;
        }

        button:hover {
            opacity: 0.8;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #result {
            border: 2px solid #333;
            background: #f0f0f0;
            padding: 15px;
            margin-top: 20px;
            font-weight: bold;
            min-height: 60px;
        }

        #error {
            border: 2px solid #dc3545;
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin-top: 20px;
            font-weight: bold;
            display: none;
        }

        .response-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* WebSocket Styles */
        .websocket-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .connection-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .status-indicator {
            font-size: 20px;
            margin-right: 10px;
        }

        .status-online {
            color: #28a745;
        }

        .status-offline {
            color: #dc3545;
        }

        .status-connecting {
            color: #ffc107;
        }

        .websocket-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-connect {
            background-color: #28a745;
            color: white;
        }

        .btn-disconnect {
            background-color: #dc3545;
            color: white;
        }

        .btn-heartbeat {
            background-color: #17a2b8;
            color: white;
        }

        .btn-register {
            background-color: #17a2b8;
            color: white;
        }

        .websocket-log {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-content {
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <h1>üéÆ TicTacToe API Tester</h1>

    <div class="input-section">
        <h3>Input Values</h3>
        <div class="input-group">
            <label>Player ID:</label>
            <input id="playerId" placeholder="Enter player UUID">
        </div>
        <div class="input-group">
            <label>Game ID:</label>
            <input id="gameId" placeholder="Enter game ID">
        </div>
        <div class="input-group">
            <label>Move:</label>
            <input id="move" placeholder="e.g., x4, o7">
        </div>
        <div class="input-group">
            <label>Choice:</label>
            <select id="choice">
                <option value="">Select player choice</option>
                <option value="X">X (First player)</option>
                <option value="O">O (Second player)</option>
            </select>
        </div>
    </div>

    <div class="button-section">
        <button class="btn-create" onclick="createGame()">Create Game</button>
        <button class="btn-state" onclick="getGameState()">Get Game State</button>
        <button class="btn-move" onclick="makeMove()">Make Move</button>
        <button class="btn-choose" onclick="choosePlayer()">Choose Player</button>
    </div>

    <!-- WebSocket Section -->
    <div class="websocket-section">
        <h3>üîå WebSocket Connection</h3>
        <div class="connection-status">
            <span id="statusIndicator" class="status-offline">‚óè</span>
            <span id="statusText">Disconnected</span>
        </div>
        <div class="websocket-controls">
            <button id="connectBtn" onclick="connectWebSocket()" class="btn-connect">Connect</button>
            <button id="disconnectBtn" onclick="disconnectWebSocket()" class="btn-disconnect"
                disabled>Disconnect</button>
            <button id="registerBtn" onclick="registerPlayer()" class="btn-register" disabled>Register Player</button>
            <button onclick="sendHeartbeat()" class="btn-heartbeat" disabled>Send Heartbeat</button>
        </div>
        <div class="websocket-log">
            <div id="wsLog" class="log-content"></div>
        </div>
    </div>

    <div id="result">Results will appear here...</div>
    <div id="error"></div>

    <script>
        // Helper function to clear outputs
        function clearOutputs() {
            document.getElementById('result').innerHTML = '';
            document.getElementById('error').style.display = 'none';
        }

        // Helper function to show result
        function showResult(message, isError = false) {
            const resultDiv = document.getElementById('result');
            const errorDiv = document.getElementById('error');

            if (isError) {
                errorDiv.innerHTML = message;
                errorDiv.style.display = 'block';
            } else {
                resultDiv.innerHTML = message;
            }
        }

        // Create Game
        async function createGame() {
            clearOutputs();
            const playerId = document.getElementById('playerId').value.trim();

            if (!playerId) {
                showResult('Please enter Player ID', true);
                return;
            }

            try {
                const response = await fetch('/api/v1/game/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_uuid: playerId })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult(`‚úÖ Game created successfully!<br><br><strong>Game ID:</strong> ${data.game_id}<br><strong>Player ID:</strong> ${playerId}`);
                    // Auto-fill the game ID field
                    document.getElementById('gameId').value = data.game_id;
                } else {
                    const errorText = await response.text();
                    showResult(`‚ùå Error ${response.status}: ${errorText}`, true);
                }
            } catch (error) {
                showResult(`‚ùå Network Error: ${error.message}`, true);
            }
        }

        // Get Game State
        async function getGameState() {
            clearOutputs();
            const gameId = document.getElementById('gameId').value.trim();
            const playerId = document.getElementById('playerId').value.trim();

            if (!gameId || !playerId) {
                showResult('Please enter both Game ID and Player ID', true);
                return;
            }

            try {
                const response = await fetch('/api/v1/game/state', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        player_uuid: playerId,
                        game_id: gameId
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult(`‚úÖ Game state retrieved!<br><br><strong>Game State:</strong> ${data.game_state}`);
                } else {
                    const errorText = await response.text();
                    showResult(`‚ùå Error ${response.status}: ${errorText}`, true);
                }
            } catch (error) {
                showResult(`‚ùå Network Error: ${error.message}`, true);
            }
        }

        // Make Move
        async function makeMove() {
            clearOutputs();
            const gameId = document.getElementById('gameId').value.trim();
            const playerId = document.getElementById('playerId').value.trim();
            const move = document.getElementById('move').value.trim();

            if (!gameId || !playerId || !move) {
                showResult('Please enter Game ID, Player ID, and Move', true);
                return;
            }

            if (move.length !== 2 || !['x', 'o'].includes(move[0].toLowerCase()) || isNaN(move[1]) || move[1] < '1' || move[1] > '9') {
                showResult('Invalid move format. Use format like "x4" or "o7" (position 0-8)', true);
                return;
            }

            try {
                const response = await fetch('/api/v1/game/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        player_uuid: playerId,
                        game_id: gameId,
                        move: move.toLowerCase()
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult(`‚úÖ Move made successfully!<br><br><strong>New Game State:</strong> ${data.game_state}`);
                } else {
                    const errorText = await response.text();
                    showResult(`‚ùå Error ${response.status}: ${errorText}`, true);
                }
            } catch (error) {
                showResult(`‚ùå Network Error: ${error.message}`, true);
            }
        }

        // Choose Player
        async function choosePlayer() {
            clearOutputs();
            const gameId = document.getElementById('gameId').value.trim();
            const playerId = document.getElementById('playerId').value.trim();
            const choice = document.getElementById('choice').value;

            if (!gameId || !playerId || !choice) {
                showResult('Please enter Game ID, Player ID, and select a choice', true);
                return;
            }

            try {
                const response = await fetch('/api/v1/game/choose_player', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        game_id: gameId,
                        player_uuid: playerId,
                        choice: choice.toLowerCase()
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult(`‚úÖ Player choice successful!<br><br><strong>You are now playing as:</strong> ${choice}`);
                } else {
                    const errorText = await response.text();
                    showResult(`‚ùå Error ${response.status}: ${errorText}`, true);
                }
            } catch (error) {
                showResult(`‚ùå Network Error: ${error.message}`, true);
            }
        }

        // WebSocket functionality
        let ws = null;
        let heartbeatInterval = null;

        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                logWebSocket('Already connected!');
                return;
            }

            updateConnectionStatus('connecting', 'Connecting...');

            try {
                ws = new WebSocket('ws://localhost:8080/ws');

                ws.onopen = function () {
                    updateConnectionStatus('online', 'Connected');
                    logWebSocket('‚úÖ WebSocket connected successfully');
                    enableWebSocketControls(true);
                    startHeartbeat();

                    // Don't auto-register anymore - user must click Register button
                    logWebSocket('üìã WebSocket connected. Click "Register Player" to join.');
                };

                ws.onmessage = function (event) {
                    logWebSocket(`üì® Received: ${event.data}`);

                    // Simple message handling - just show what we got
                    showResult(`WebSocket Message: ${event.data}`);
                };

                ws.onclose = function () {
                    updateConnectionStatus('offline', 'Disconnected');
                    logWebSocket('‚ùå WebSocket disconnected');
                    enableWebSocketControls(false);
                    stopHeartbeat();

                    // üî• Create NEW WebSocket connection
                    setTimeout(() => {
                        if (document.getElementById('playerId').value) {
                            logWebSocket('üîÑ Creating new WebSocket connection...');
                            connectWebSocket();  // This creates a completely new WebSocket
                        }
                    }, 3000);
                };

                ws.onerror = function (error) {
                    updateConnectionStatus('offline', 'Connection Error');
                    logWebSocket(`‚ùå WebSocket error: ${error}`);
                    enableWebSocketControls(false);
                    stopHeartbeat();
                };

            } catch (error) {
                updateConnectionStatus('offline', 'Connection Failed');
                logWebSocket(`‚ùå Failed to create WebSocket: ${error.message}`);
            }
        }

        // NEW FUNCTION: Explicit player registration
        function registerPlayer() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                logWebSocket('‚ùå WebSocket not connected');
                return;
            }

            const playerId = document.getElementById('playerId').value.trim();
            const gameId = document.getElementById('gameId').value.trim();

            if (!playerId) {
                logWebSocket('‚ö†Ô∏è Please enter a Player ID first');
                return;
            }

            const registerMessage = {
                message: 'register',
                player_uuid: playerId,
                game_id: gameId || ''
            };

            ws.send(JSON.stringify(registerMessage));
            logWebSocket('üì§ Sent register message: ' + JSON.stringify(registerMessage));

            // Disable register button after successful registration
            document.getElementById('registerBtn').disabled = true;
            document.getElementById('registerBtn').textContent = 'Registered';
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
            updateConnectionStatus('offline', 'Disconnected');
            enableWebSocketControls(false);

            // Reset register button
            document.getElementById('registerBtn').disabled = true;
            document.getElementById('registerBtn').textContent = 'Register Player';

            stopHeartbeat();
            logWebSocket('üîå WebSocket manually disconnected');
        }

        function sendHeartbeat() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const heartbeat = {
                    type: 'heartbeat',
                    timestamp: new Date().toISOString(),
                    message: 'ping'
                };

                ws.send(JSON.stringify(heartbeat));
                logWebSocket(`üíì Sent heartbeat: ${JSON.stringify(heartbeat)}`);
            } else {
                logWebSocket('‚ùå Cannot send heartbeat - not connected');
            }
        }

        function updateConnectionStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            // Remove all status classes
            indicator.classList.remove('status-online', 'status-offline', 'status-connecting');

            // Add appropriate status class
            switch (status) {
                case 'online':
                    indicator.classList.add('status-online');
                    break;
                case 'offline':
                    indicator.classList.add('status-offline');
                    break;
                case 'connecting':
                    indicator.classList.add('status-connecting');
                    break;
            }

            statusText.textContent = text;
        }

        function enableWebSocketControls(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('registerBtn').disabled = !connected; // Enable register button only if connected
            document.querySelector('.btn-heartbeat').disabled = !connected;
        }

        function startHeartbeat() {
            // Send heartbeat every 30 seconds
            heartbeatInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    sendHeartbeat();
                }
            }, 30000);
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        function logWebSocket(message) {
            const logDiv = document.getElementById('wsLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    </script>
</body>

</html>